<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dev.zeronelab.mybatis.mapper.nBoardMapper">

	<!-- 게시물 전체 목록 조회 쿼리 -->
	<select id="selectBoardList"
		resultType="dev.zeronelab.mybatis.vo.nBoardVO" parameterType="map">
	<![CDATA[
    	SELECT * FROM (
        	SELECT
            	bNo, title, content, writer, regidate, viewCnt, replyCnt,
            	ROW_NUMBER() OVER (ORDER BY bNo DESC, regidate DESC) AS rnum
        	FROM
            	nBoard
    		)numbered
    	WHERE
        	numbered.rnum BETWEEN  #{pageStart} +1 AND (#{pageStart} + #{perPageNum})
    	ORDER BY 
    		numbered.rnum
    ]]>
	</select>


	<!-- <select id="listCriteria" resultType="dev.zeronelab.mybatis.vo.nBoardVO"> 
		<![CDATA[ SELECT * FROM ( select bNo, title, content, writer, regidate, viewCnt 
		, replyCnt, ROW_NUMBER() OVER (ORDER BY bNo DESC, regidate DESC) AS rnum 
		from nBoard where bNo > 0 ) WHERE rnum BETWEEN #{pageStart} AND (#{pageStart} 
		+ #{perPageNum} - 1) order by bNo desc, regidate desc limit #{pageStart}, 
		#{perPageNum} ]]> </select> -->

	<!-- 검색 조건에 따른 게시물 목록 조회 쿼리 -->
	<select id="listSearch"
		resultType="dev.zeronelab.mybatis.vo.nBoardVO">
		SELECT * FROM (
		SELECT
		bNo, title, content, writer, regidate, viewCnt, replyCnt,
		ROW_NUMBER() OVER (ORDER BY bNo DESC, regidate DESC) AS rnum
		FROM
		nBoard
		WHERE
		bNo > 0
		<if test="searchType == 't'.toString()">
			AND (title LIKE '%' || #{keyword} || '%')
		</if>
		<if test="searchType == 'c'.toString()">
			AND (content LIKE '%' || #{keyword} || '%')
		</if>
		<if test="searchType == 'w'.toString()">
			AND (writer LIKE '%' || #{keyword} || '%')
		</if>
		<if test="searchType == 'tc'.toString()">
			AND (title LIKE '%' || #{keyword} || '%' OR content LIKE '%' ||
			#{keyword} || '%')
		</if>
		<if test="searchType == 'cw'.toString()">
			AND (content LIKE '%' || #{keyword} || '%' OR writer LIKE '%' ||
			#{keyword} || '%')
		</if>
		<if test="searchType == 'tcw'.toString()">
			AND (title LIKE '%' || #{keyword} || '%' OR content LIKE '%' ||
			#{keyword} || '%' OR writer LIKE '%' || #{keyword} || '%')
		</if>
		)
		WHERE
		rnum BETWEEN #{pageStart} + 1 AND (#{pageStart} + #{perPageNum})
		ORDER BY
		rnum
	</select>


	<!-- 검색 조건에 따른 게시물 수 조회 쿼리 -->
	<select id="selectBoardListCount" resultType="int">
	<![CDATA[
		SELECT COUNT(*) FROM nBoard
		WHERE bNo > 0
	]]>
	</select>


	<!-- 검색 조건에 따른 게시물의 총 개수를 가져오는 쿼리 -->
	<select id="listSearchCount" resultType="int">
		SELECT COUNT(*) FROM nBoard
		<include refid="search" />
	</select>


	<!-- <select id="countPaging" resultType="int"> <![CDATA[ SELECT COUNT(bNo) 
		FROM nBoard WHERE bNo > 0 ]]> </select> -->

	<!-- 검색 조건 SQL -->
	<sql id="search">
		<if test="searchType != null">
			<where>
				<if test="searchType == 't'.toString()">
					AND title LIKE '%' || #{keyword} || '%'
				</if>
				<if test="searchType == 'c'.toString()">
					AND content LIKE '%' || #{keyword} || '%'
				</if>
				<if test="searchType == 'w'.toString()">
					AND writer LIKE '%' || #{keyword} || '%'
				</if>
				<if test="searchType == 'tc'.toString()">
					AND (title LIKE '%' || #{keyword} || '%' OR content LIKE
					'%' || #{keyword} || '%')
				</if>
				<if test="searchType == 'cw'.toString()">
					AND (content LIKE '%' || #{keyword} || '%' OR writer
					LIKE '%' || #{keyword} || '%')
				</if>
				<if test="searchType == 'tcw'.toString()">
					AND (title LIKE '%' || #{keyword} || '%' OR content LIKE
					'%' || #{keyword} || '%' OR writer LIKE '%' || #{keyword} || '%')
				</if>
			</where>
		</if>
	</sql>


	<!-- 글 작성 -->
	<insert id="write">
	<![CDATA[
		insert into nBoard (writer, title, content, viewCnt, replyCnt)
		values(#{writer}, #{title}, #{content}, #{viewCnt}, #{replyCnt})
	]]>
	</insert>


	<!-- 글 조회 -->
	<select id="read"
		resultType="dev.zeronelab.mybatis.dto.nBoardDTO">
		SELECT *
		FROM nBoard
		LEFT JOIN nAttach ON nBoard.bNo = nAttach.bNo
		WHERE nBoard.bNo = #{bNo}
	</select>


	<!-- 글 삭제 -->
	<delete id="delete">
		delete
		from nBoard
		where bNo = #{bNo}
	</delete>


	<!-- 조회수 -->
	<update id="updateCounts">
	<![CDATA[
   		update nBoard
  		set viewcnt = viewcnt + 1
   		where bNo = #{bNo}
    ]]>
	</update>


	<!-- 글 수정 -->
	<update id="update" parameterType="map">
	<![CDATA[
		update nBoard
		set title = #{title}, content = #{content}
		where bNo = #{bNo}
	]]>
	</update>


	<!-- 첨부파일 -->
	<insert id="addAttach">
	<![CDATA[
		INSERT INTO nAttach (imgName, uuid, path,  bNo)
		VALUES (#{imgName}, #{uuid}, #{path}, bNo_seq.CURRVAL)
	]]>
	</insert>

	<select id="getAttach" resultType="string">
	<![CDATA[
		SELECT path || '/s_' || uuid || '_' || imgName AS combinedString
FROM nAttach
WHERE bNo = 30
ORDER BY regdate
			]]>
	</select>

	<!-- <select id="getAttach" resultType="string" > <![CDATA[ select imgName 
		from nAttach where bNo = #{bNo} order by regdate ]]> </select> -->


	<!-- 수정 -->
	<insert id="replaceAttach">
	<![CDATA[
		INSERT INTO nAttach (imgName, uuid, path,  bNo)
		VALUES (#{imgName}, #{uuid}, #{path}, #{bNo})
	]]>
	</insert>

	<!-- 삭제 -->
	<delete id="deleteAttach">
	<![CDATA[
delete from nAttach where bNo = #{bNo}
]]>
	</delete>

</mapper>
